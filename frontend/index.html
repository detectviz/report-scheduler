<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>報表排程系統 - 前端原型</title>
    <!-- React, Babel, Day.js -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/relativeTime.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/isBetween.js"></script>
    <!-- Ant Design -->
    <script src="https://unpkg.com/antd@5.19.1/dist/antd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.19.1/dist/reset.css" />
    <link rel="stylesheet" href="https://unpkg.com/antd@5.19.1/dist/antd.min.css" />
    <!-- Ant Design Icons -->
    <script src="https://unpkg.com/@ant-design/icons@5.3.7/dist/index.umd.min.js"></script>
    <style>
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .logo {
            height: 32px;
            margin: 16px;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .ant-layout-header {
            color: #fff;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const { Layout, Menu, Typography } = antd;
        const {
            DatabaseOutlined,
            FileTextOutlined,
            ScheduleOutlined,
            HistoryOutlined,
        } = icons;

        const { Header, Content, Footer, Sider } = Layout;
        const { Title } = Typography;

        const DataSourceManagementPage = () => {
            const { Button, Modal, Form, Input, Select, message, Table, Tag, Space } = antd;
            const { useEffect } = React;
            const [isModalVisible, setIsModalVisible] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [selectedType, setSelectedType] = useState(null);
            const [form] = Form.useForm();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchData = () => {
                setLoading(true);
                fetch("/api/v1/datasources")
                    .then(res => res.json())
                    .then(apiData => {
                        // The key property is required by Ant Design's Table
                        const tableData = (apiData || []).map(item => ({ ...item, key: item.id }));
                        setData(tableData);
                        setLoading(false);
                    })
                    .catch(error => {
                        console.error("Fetch error:", error);
                        message.error('無法獲取資料來源列表');
                        setLoading(false);
                    });
            };

            useEffect(() => {
                fetchData();
            }, []);

            useEffect(() => {
                if (editingRecord) {
                    form.setFieldsValue(editingRecord);
                    setSelectedType(editingRecord.type);
                } else {
                    form.resetFields();
                    setSelectedType(null);
                }
            }, [editingRecord, form]);

            const showModal = (record = null) => {
                setEditingRecord(record);
                // 當打開 Modal 時，如果沒有正在編輯的紀錄，也要清除類型選擇
                if (!record) {
                    setSelectedType(null);
                }
                setIsModalVisible(true);
            };

            const handleOk = () => {
                form.validateFields()
                    .then(values => {
                        // For fields that might not be visible (like api_url), ensure they are included if they have a value.
                        const payload = { ...editingRecord, ...values };

                        const method = editingRecord ? 'PUT' : 'POST';
                        const url = editingRecord
                            ? `/api/v1/datasources/${editingRecord.id}`
                            : '/api/v1/datasources';

                        fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        })
                        .then(res => {
                            if (res.ok) {
                                setIsModalVisible(false);
                                message.success(editingRecord ? '資料來源已更新' : '資料來源已新增');
                                fetchData(); // Refresh the table
                            } else {
                                message.error('操作失敗，請檢查後端日誌');
                            }
                        })
                        .catch(err => {
                            console.error("API call error:", err);
                            message.error('網路請求失敗');
                        });
                    })
                    .catch(info => {
                        console.log('Validate Failed:', info);
                    });
            };

            const handleCancel = () => {
                setIsModalVisible(false);
            };

            const handleValidate = (record) => {
                message.loading({ content: `正在驗證 "${record.name}"...`, key: 'validate' });
                setTimeout(() => {
                    if (Math.random() > 0.3) {
                        message.success({ content: `"${record.name}" 連線成功！`, key: 'validate', duration: 2 });
                    } else {
                        message.error({ content: `"${record.name}" 連線失敗，請檢查設定。`, key: 'validate', duration: 2 });
                    }
                }, 1500);
            };

            const columns = [
                { title: '名稱', dataIndex: 'name', key: 'name', render: text => <a>{text}</a> },
                { title: '類型', dataIndex: 'type', key: 'type', render: type => {
                    let color = 'geekblue';
                    if (type === 'grafana') color = 'volcano';
                    if (type === 'elasticsearch') color = 'green';
                    return <Tag color={color}>{type.toUpperCase()}</Tag>;
                }},
                { title: 'URL', dataIndex: 'url', key: 'url' },
                { title: '版本', dataIndex: 'version', key: 'version' },
                { title: '狀態', dataIndex: 'status', key: 'status', render: status => {
                    let color;
                    if (status === 'verified') color = 'success';
                    else if (status === 'unverified') color = 'warning';
                    else color = 'error';
                    const text = status === 'verified' ? '已驗證' : status === 'unverified' ? '未驗證' : '連線失敗';
                    return <Tag color={color}>{text}</Tag>;
                }},
                { title: '操作', key: 'action', render: (text, record) => (
                    <Space size="middle">
                        <a onClick={() => showModal(record)}>編輯</a>
                        <a>刪除</a>
                        <a onClick={() => handleValidate(record)}>驗證連線</a>
                    </Space>
                )},
            ];

            return (
                <div>
                    <Button type="primary" onClick={() => showModal()} style={{ marginBottom: 16 }}>新增資料來源</Button>
                    <Table columns={columns} dataSource={data} loading={loading} />
                    <Modal title={editingRecord ? '編輯資料來源' : '新增資料來源'} open={isModalVisible} onOk={handleOk} onCancel={handleCancel} destroyOnClose>
                        <Form form={form} layout="vertical" name="dataSourceForm">
                            <Form.Item name="name" label="名稱" rules={[{ required: true, message: '請輸入名稱' }]}><Input /></Form.Item>
                            <Form.Item name="type" label="類型" rules={[{ required: true, message: '請選擇類型' }]}>
                                <Select placeholder="請選擇資料來源類型" onChange={setSelectedType}>
                                    <Select.Option value="kibana">Kibana</Select.Option>
                                    <Select.Option value="grafana">Grafana</Select.Option>
                                </Select>
                            </Form.Item>

                            {selectedType === 'kibana' && (
                                <>
                                    <Form.Item name="url" label="Kibana URL" rules={[{ required: true, message: '請輸入 Kibana URL' }]}>
                                        <Input placeholder="https://kibana.mycompany.com" />
                                    </Form.Item>
                                    <Form.Item name="api_url" label="Elasticsearch API URL" rules={[{ required: true, message: '請輸入 Elasticsearch API URL' }]}>
                                        <Input placeholder="https://es.mycompany.com:9200" />
                                    </Form.Item>
                                </>
                            )}

                            {selectedType === 'grafana' && (
                                <Form.Item name="url" label="Grafana URL" rules={[{ required: true, message: '請輸入 Grafana URL' }]}>
                                    <Input placeholder="https://grafana.mycompany.com" />
                                </Form.Item>
                            )}

                            <Form.Item name="version" label="版本"><Input /></Form.Item>
                        </Form>
                    </Modal>
                </div>
            );
        };

        const ScheduleManagementPage = () => {
            const { Button, Modal, Form, Input, Select, Switch, message, Table, Tag, Space } = antd;
            const { useEffect } = React;
            const [isModalVisible, setIsModalVisible] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [form] = Form.useForm();
            const [schedules, setSchedules] = useState([
              {
                key: '1',
                name: '每日營運日報',
                cron_spec: '0 9 * * 1-5',
                recipients: 'ops-team@mycompany.com',
                is_enabled: true,
              },
              {
                key: '2',
                name: '每週產品銷售報表',
                cron_spec: '0 10 * * 1',
                recipients: 'sales@mycompany.com, product@mycompany.com',
                is_enabled: true,
              },
              {
                key: '3',
                name: '月底財務結算報表',
                cron_spec: '0 22 L * *',
                recipients: 'finance-dept@mycompany.com',
                is_enabled: false,
              },
            ]);

            const handleSwitchChange = (checked, record) => {
                const newSchedules = schedules.map(item => {
                    if (item.key === record.key) {
                        return { ...item, is_enabled: checked };
                    }
                    return item;
                });
                setSchedules(newSchedules);
            };

            useEffect(() => {
                if (editingRecord) {
                    form.setFieldsValue(editingRecord);
                } else {
                    form.resetFields();
                }
            }, [editingRecord, form]);

            const showModal = (record = null) => {
                setEditingRecord(record);
                setIsModalVisible(true);
            };

            const handleOk = () => {
                form.validateFields().then(values => {
                    setIsModalVisible(false);
                    message.success(editingRecord ? '排程已更新' : '排程已新增');
                }).catch(info => {
                    console.log('Validate Failed:', info);
                });
            };

            const handleCancel = () => {
                setIsModalVisible(false);
            };

            const handleTest = (record) => {
                message.loading({ content: `正在測試排程 "${record.name}"...`, key: 'test' });
                setTimeout(() => {
                    message.success({ content: `"${record.name}" 測試郵件已寄送！`, key: 'test', duration: 2 });
                }, 1500);
            };

            const scheduleColumns = [
                { title: '排程名稱', dataIndex: 'name', key: 'name' },
                { title: 'Cron 表達式', dataIndex: 'cron_spec', key: 'cron_spec', render: text => <code>{text}</code> },
                { title: '收件者', dataIndex: 'recipients', key: 'recipients' },
                {
                    title: '狀態',
                    dataIndex: 'is_enabled',
                    key: 'is_enabled',
                    render: (isEnabled, record) => (
                        <Switch checked={isEnabled} onChange={(checked) => handleSwitchChange(checked, record)} />
                    )
                },
                {
                    title: '操作',
                    key: 'action',
                    render: (text, record) => (
                        <Space size="middle">
                            <a onClick={() => showModal(record)}>編輯</a>
                            <Button type="primary" size="small" onClick={() => handleTest(record)}>立即測試</Button>
                            <Button type="primary" danger size="small">刪除</Button>
                        </Space>
                    ),
                },
            ];

            return (
                <div>
                    <Button type="primary" onClick={() => showModal()} style={{ marginBottom: 16 }}>
                        新增排程
                    </Button>
                    <Table columns={scheduleColumns} dataSource={schedules} />
                    <Modal
                        title={editingRecord ? '編輯排程' : '新增排程'}
                        open={isModalVisible}
                        onOk={handleOk}
                        onCancel={handleCancel}
                        destroyOnClose
                    >
                        <Form form={form} layout="vertical" name="scheduleForm">
                            <Form.Item name="name" label="排程名稱" rules={[{ required: true }]}>
                                <Input />
                            </Form.Item>
                            <Form.Item name="cron_spec" label="Cron 表達式" rules={[{ required: true }]}>
                                <Input />
                            </Form.Item>
                            <Form.Item name="recipients" label="收件者 (以逗號分隔)" rules={[{ required: true }]}>
                                <Input.TextArea rows={3} />
                            </Form.Item>
                        </Form>
                    </Modal>
                </div>
            );
        };

        const HistoryPage = () => {
            const { Table, Tag, Space, Button, Modal, message, Descriptions } = antd;
            const [isDetailModalVisible, setIsDetailModalVisible] = useState(false);
            const [selectedRecord, setSelectedRecord] = useState(null);

            const handleResend = (record) => {
                 message.loading({ content: `正在重送紀錄 "${record.scheduleName}"...`, key: 'resend' });
                setTimeout(() => {
                    message.success({ content: `紀錄 "${record.scheduleName}" 已成功重送！`, key: 'resend', duration: 2 });
                }, 1500);
            };

            const showDetails = (record) => {
                setSelectedRecord(record);
                setIsDetailModalVisible(true);
            };

            const handleDetailModalClose = () => {
                setIsDetailModalVisible(false);
                setSelectedRecord(null);
            };

            const mockHistoryData = [
              {
                key: '1',
                scheduleName: '每日營運日報',
                triggerTime: '2023-10-27 09:00:01',
                duration: '35s',
                status: 'success',
                recipients: 'ops-team@mycompany.com',
                reportURL: 'https://storage.minio/reports/report-1.pdf'
              },
              {
                key: '2',
                scheduleName: '每週產品銷售報表',
                triggerTime: '2023-10-27 08:00:05',
                duration: '1m 12s',
                status: 'success',
                recipients: 'sales@mycompany.com',
                reportURL: 'https://storage.minio/reports/report-2.pdf'
              },
              {
                key: '3',
                scheduleName: '每日營運日報',
                triggerTime: '2023-10-26 09:00:02',
                duration: '2m 5s',
                status: 'error',
                errorMessage: 'Kibana server timeout: Failed to fetch data from dashboard [dashboard-id]',
                recipients: 'ops-team@mycompany.com',
                reportURL: null
              },
            ];

            const historyColumns = [
                { title: '排程名稱', dataIndex: 'scheduleName', key: 'scheduleName' },
                { title: '觸發時間', dataIndex: 'triggerTime', key: 'triggerTime' },
                { title: '執行耗時', dataIndex: 'duration', key: 'duration' },
                {
                    title: '狀態',
                    dataIndex: 'status',
                    key: 'status',
                    render: status => {
                        let color = status === 'success' ? 'success' : 'error';
                        return <Tag color={color}>{status.toUpperCase()}</Tag>;
                    }
                },
                {
                    title: '操作',
                    key: 'action',
                    render: (text, record) => (
                        <Space size="middle">
                            <Button size="small" onClick={() => showDetails(record)}>查看詳情</Button>
                            <Button type="primary" size="small" onClick={() => handleResend(record)}>重寄</Button>
                        </Space>
                    ),
                },
            ];

            return (
                <div>
                    <Table columns={historyColumns} dataSource={mockHistoryData} />
                    <Modal
                        title="執行紀錄詳情"
                        open={isDetailModalVisible}
                        onCancel={handleDetailModalClose}
                        footer={[
                            <Button key="back" onClick={handleDetailModalClose}>
                              關閉
                            </Button>,
                          ]}
                    >
                        {selectedRecord && (
                            <Descriptions bordered column={1}>
                                <Descriptions.Item label="排程名稱">{selectedRecord.scheduleName}</Descriptions.Item>
                                <Descriptions.Item label="觸發時間">{selectedRecord.triggerTime}</Descriptions.Item>
                                <Descriptions.Item label="執行耗時">{selectedRecord.duration}</Descriptions.Item>
                                <Descriptions.Item label="狀態">
                                    <Tag color={selectedRecord.status === 'success' ? 'success' : 'error'}>
                                        {selectedRecord.status.toUpperCase()}
                                    </Tag>
                                </Descriptions.Item>
                                <Descriptions.Item label="收件者">{selectedRecord.recipients}</Descriptions.Item>
                                {selectedRecord.status === 'error' && (
                                     <Descriptions.Item label="錯誤訊息">{selectedRecord.errorMessage}</Descriptions.Item>
                                )}
                                {selectedRecord.reportURL && (
                                     <Descriptions.Item label="報表連結"><a>{selectedRecord.reportURL}</a></Descriptions.Item>
                                )}
                            </Descriptions>
                        )}
                    </Modal>
                </div>
            );
        };

        const ReportDefinitionPage = () => {
            const { Form, Input, Select, DatePicker, Divider, Transfer, Button, message } = antd;
            const { RangePicker } = DatePicker;
            const [targetKeys, setTargetKeys] = useState(['1', '5']);
            const [selectedKeys, setSelectedKeys] = useState([]);
            const [form] = Form.useForm();

            const mockReportElements = Array.from({ length: 20 }).map((_, i) => ({
              key: i.toString(),
              title: `儀表板或圖表 ${i + 1}`,
              description: `這是項目 ${i + 1} 的描述`,
            }));

            const onTransferChange = (nextTargetKeys) => {
                setTargetKeys(nextTargetKeys);
            };

            const onTransferSelectChange = (sourceSelectedKeys, targetSelectedKeys) => {
                setSelectedKeys([...sourceSelectedKeys, ...targetSelectedKeys]);
            };

            const onSave = () => {
                form.validateFields().then(values => {
                    message.success('報表定義已儲存！');
                }).catch(info => {
                    console.log('Validate Failed:', info);
                });
            };

            return (
                <Form form={form} layout="vertical" onFinish={onSave}>
                    <Title level={4}>基本資訊</Title>
                    <Form.Item label="報表名稱" name="reportName" rules={[{ required: true, message: '請輸入報表名稱' }]}>
                        <Input placeholder="例如：每日網站流量分析報表" />
                    </Form.Item>
                     <Form.Item label="選擇資料來源" name="dataSource" rules={[{ required: true, message: '請選擇一個資料來源' }]}>
                        <Select placeholder="選擇一個已驗證的資料來源">
                            <Select.Option value="kibana_prod">公司正式環境 Kibana</Select.Option>
                            <Select.Option value="grafana_test" disabled>測試環境 Grafana (未驗證)</Select.Option>
                        </Select>
                    </Form.Item>
                    <Form.Item label="設定時間範圍" name="timeRange" rules={[{ required: true, message: '請設定時間範圍' }]}>
                        <RangePicker style={{ width: '100%' }} />
                    </Form.Item>
                    <Divider />
                    <Title level={4}>挑選報表元素</Title>
                    <p>請從左側選擇您想包含在此報表中的儀表板或圖表，並可拖曳右側項目進行排序。</p>
                    <Transfer
                        dataSource={mockReportElements}
                        titles={['可選項目', '已選項目']}
                        targetKeys={targetKeys}
                        selectedKeys={selectedKeys}
                        onChange={onTransferChange}
                        onSelectChange={onTransferSelectChange}
                        render={item => item.title}
                        listStyle={{
                          width: '100%',
                          height: 300,
                        }}
                        oneWay
                        />
                    <Divider />
                     <Form.Item>
                        <Button type="primary" htmlType="submit">儲存報表定義</Button>
                    </Form.Item>
                </Form>
            );
        };

        const App = () => {
            const [collapsed, setCollapsed] = useState(false);
            const [selectedKey, setSelectedKey] = useState('1');

            const menuItems = [
                { key: '1', icon: <DatabaseOutlined />, label: '資料來源管理' },
                { key: '2', icon: <FileTextOutlined />, label: '報表定義' },
                { key: '3', icon: <ScheduleOutlined />, label: '排程管理' },
                { key: '4_1', icon: <HistoryOutlined />, label: '歷史紀錄與稽核' },
            ];

            const pageTitles = {
                '1': '資料來源管理',
                '2': '報表定義',
                '3': '排程管理',
                '4_1': '歷史紀錄與稽核',
            };

            const renderContent = () => {
                switch(selectedKey) {
                    case '1':
                        return <DataSourceManagementPage />;
                    case '2':
                        return <ReportDefinitionPage />;
                    case '3':
                        return <ScheduleManagementPage />;
                    case '4_1':
                        return <HistoryPage />;
                    default:
                        return "請選擇一個項目";
                }
            };

            return (
                <Layout style={{ minHeight: '100vh' }}>
                    <Sider collapsible collapsed={collapsed} onCollapse={setCollapsed}>
                        <div className="logo">報表系統</div>
                        <Menu theme="dark" selectedKeys={[selectedKey]} mode="inline" items={menuItems} onClick={({ key }) => setSelectedKey(key)} />
                    </Sider>
                    <Layout className="site-layout">
                        <Header className="site-layout-background" style={{ padding: '0 24px', background: '#fff' }}>
                           <Title level={3} style={{ margin: '16px 0' }}>{pageTitles[selectedKey]}</Title>
                        </Header>
                        <Content style={{ margin: '24px 16px 0' }}>
                            <div className="site-layout-background" style={{ padding: 24, minHeight: 360, background: '#fff' }}>
                                {renderContent()}
                            </div>
                        </Content>
                        <Footer style={{ textAlign: 'center' }}>
                            Report Scheduler ©{new Date().getFullYear()} Created with Ant Design
                        </Footer>
                    </Layout>
                </Layout>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
